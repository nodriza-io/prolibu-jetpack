const vscode = require('vscode');
const chokidar = require('chokidar');
const fs = require('fs');
const path = require('path');

function activate(context) {

  	let disposable = vscode.commands.registerCommand(
    "extension.abrirCsv",
    function () {
		const terminal = vscode.window.createTerminal("Prolibu");
		terminal.show();
	
		const cliPath = path.join(__dirname, 'cli.js');
	
		terminal.sendText(`alias prolibu="node ${cliPath}"`);
	}
  );

  // Iniciar el observador en una carpeta
	const watcher = chokidar.watch(__dirname, 'accounts', {
		ignored: /(^|[\/\\])\../, // Ignorar archivos que empiezan con un punto
		persistent: true
	});

	watcher.on('add', (newFilePath) => {
		console.log(`Nuevo archivo añadido: ${newFilePath}`);
		
		const backupPath = path.join(path.dirname(newFilePath), '/.data/backup.xlsx');
		
		fs.copyFile(newFilePath, backupPath, (err) => {
			if (err) throw err;
			console.log('Archivo original copiado para respaldo.');
		});
	});

	// Al detectar cambios en un archivo
	watcher.on('change', (changedPath) => {
		console.log(`Archivo modificado: ${changedPath}`);
		// Aquí puedes comparar el archivo modificado con tu copia de respaldo.
	});

  context.subscriptions.push(disposable);
}

exports.activate = activate;
